<%- layout('layouts/boilerplate') %>

<%
  // ✅ Compatible with old + new
  const user = (typeof currUser !== "undefined" && currUser)
    ? currUser
    : (typeof currentUser !== "undefined" ? currentUser : null);

  const owner = listing?.owner || null;
  const imageUrl = listing?.image?.url || "/images/default.jpg";

  const reviewsArr = listing?.reviews || [];
  const hasReviews = reviewsArr.length > 0;

  const avgRating = hasReviews
    ? (reviewsArr.reduce((sum, r) => sum + (r.rating || 0), 0) / reviewsArr.length).toFixed(2)
    : null;

  const isOwner = !!(user && owner && owner._id && user._id && owner._id.equals(user._id));
%>

<style>
  .show-container {
    max-width: 1200px;
    margin: 100px auto 40px;
    padding: 0 40px;
  }

  .title-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 16px;
    margin-bottom: 10px;
  }

  h1 {
    font-size: 32px;
    font-weight: 600;
    margin: 0;
  }

  .back-link {
    text-decoration: none;
    font-weight: 600;
    color: #222;
    border: 1px solid #ddd;
    padding: 10px 14px;
    border-radius: 10px;
    background: #fff;
    transition: background 0.2s;
    white-space: nowrap;
  }

  .back-link:hover { background: #f7f7f7; color: #222; }

  .listing-meta {
    display: flex;
    gap: 20px;
    align-items: center;
    margin-bottom: 24px;
    font-size: 14px;
    color: #222;
  }

  .rating { font-weight: 600; }

  .image-gallery {
    border-radius: 12px;
    overflow: hidden;
    height: 480px;
    margin-bottom: 48px;
  }

  .image-gallery img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .content-grid {
    display: grid;
    grid-template-columns: 1.5fr 1fr;
    gap: 80px;
  }

  .host-info {
    display: flex;
    gap: 16px;
    padding-bottom: 24px;
    border-bottom: 1px solid #ebebeb;
    margin-bottom: 24px;
  }

  .host-avatar {
    width: 56px;
    height: 56px;
    border-radius: 50%;
    background: #FF385C;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 24px;
    font-weight: 600;
  }

  .host-details h3 {
    font-size: 18px;
    font-weight: 600;
    margin: 0 0 4px 0;
  }

  .host-details p {
    color: #717171;
    font-size: 14px;
    margin: 0;
  }

  .description {
    line-height: 1.8;
    color: #222;
    margin-bottom: 32px;
    padding-bottom: 32px;
    border-bottom: 1px solid #ebebeb;
  }

  .info-list {
    margin-bottom: 32px;
    padding-bottom: 32px;
    border-bottom: 1px solid #ebebeb;
  }

  .info-row {
    display: flex;
    justify-content: space-between;
    gap: 14px;
    padding: 12px 0;
    border-bottom: 1px solid #f0f0f0;
    font-size: 14px;
  }
  .info-row:last-child { border-bottom: none; }

  .info-row strong { color: #222; }
  .info-row span { color: #717171; }

  .booking-card {
    position: sticky;
    top: 120px;
    border: 1px solid #ddd;
    border-radius: 12px;
    padding: 24px;
    box-shadow: 0 6px 16px rgba(0,0,0,0.12);
    background: #fff;
  }

  .price {
    font-size: 24px;
    font-weight: 600;
    margin-bottom: 16px;
  }

  .price span {
    font-size: 16px;
    font-weight: 400;
    color: #717171;
  }

  .reserve-btn {
    width: 100%;
    background: linear-gradient(to right, #E61E4D 0%, #E31C5F 50%, #D70466 100%);
    color: white;
    border: none;
    padding: 14px;
    border-radius: 8px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.1s;
    text-decoration: none;
    display: block;
    text-align: center;
  }

  .reserve-btn:hover { transform: scale(1.02); color: white; }

  .edit-delete-btns {
    display: flex;
    gap: 12px;
    margin-top: 16px;
  }

  .btn-edit, .btn-delete {
    flex: 1;
    padding: 10px;
    border-radius: 8px;
    font-weight: 600;
    cursor: pointer;
    text-align: center;
    text-decoration: none;
  }

  .btn-edit { background: #222; color: white; border: none; }

  .btn-delete {
    background: white;
    color: #E61E4D;
    border: 1px solid #E61E4D;
  }

  .reviews-section {
    margin-top: 48px;
    padding-top: 48px;
    border-top: 1px solid #ebebeb;
  }

  .reviews-section h3 {
    font-size: 22px;
    font-weight: 600;
    margin-bottom: 24px;
  }

  .add-review {
    background: #f7f7f7;
    padding: 24px;
    border-radius: 12px;
    margin-bottom: 32px;
  }

  .add-review h4 {
    font-size: 18px;
    font-weight: 600;
    margin-bottom: 16px;
  }

  .add-review textarea {
    width: 100%;
    padding: 12px;
    border: 1px solid #ddd;
    border-radius: 8px;
    font-family: inherit;
    margin-bottom: 12px;
    resize: vertical;
  }

  /* ✅ range style (old logic, new look) */
  .range-wrap {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 14px;
  }
  .range-wrap .value {
    min-width: 52px;
    font-weight: 700;
    color: #222;
  }

  .reviews-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 32px;
  }

  .review {
    padding: 18px 0;
    border-bottom: 1px solid #f0f0f0;
  }

  .review-header {
    display: flex;
    gap: 12px;
    margin-bottom: 10px;
    align-items: center;
  }

  .review-avatar {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    background: #717171;
    color: white;
    display: flex;
    align-items: center;
    justify-content: center;
    font-weight: 700;
  }

  .review-author h4 { font-size: 15px; font-weight: 700; margin: 0; }
  .review-author p { font-size: 13px; color: #717171; margin: 0; }

  .review-rating {
    color: #FFD700;
    margin-bottom: 8px;
    font-size: 14px;
    font-weight: 700;
  }

  .review-text { font-size: 14px; line-height: 1.6; color: #222; margin: 0; }

  .delete-review {
    background: none;
    border: none;
    color: #E61E4D;
    cursor: pointer;
    font-size: 12px;
    margin-top: 10px;
    padding: 0;
  }

  @media (max-width: 768px) {
    .show-container { padding: 0 24px; margin-top: 80px; }
    .content-grid { grid-template-columns: 1fr; gap: 40px; }
    .booking-card { position: static; }
    .reviews-grid { grid-template-columns: 1fr; }
    .image-gallery { height: 320px; }
  }
</style>

<div class="show-container">

  <div class="title-row">
    <h1><%= listing.title %></h1>
    <a class="back-link" href="/listings">← Back</a>
  </div>

  <div class="listing-meta">
    <% if (hasReviews) { %>
      <span class="rating">★ <%= avgRating %> · <%= reviewsArr.length %> reviews</span>
      <span>·</span>
    <% } %>
    <span><%= listing.location %>, <%= listing.country %></span>
  </div>

  <div class="image-gallery">
    <img src="<%= imageUrl %>" alt="<%= listing.title %>">
  </div>

  <div class="content-grid">
    <!-- LEFT -->
    <div class="main-content">
      <div class="host-info">
        <div class="host-avatar">
          <%= owner?.username ? owner.username.charAt(0).toUpperCase() : "?" %>
        </div>
        <div class="host-details">
          <h3>Hosted by <%= owner?.username || "Unknown" %></h3>
          <p>Hosting since <%= listing?.createdAt ? new Date(listing.createdAt).getFullYear() : "—" %></p>
        </div>
      </div>

      <div class="description">
        <p><%= listing.description %></p>
      </div>

      <div class="info-list">
        <div class="info-row">
          <strong>Location</strong>
          <span><%= listing.location %></span>
        </div>
        <div class="info-row">
          <strong>Country</strong>
          <span><%= listing.country %></span>
        </div>
      </div>

      <!-- Reviews Section -->
      <div class="reviews-section">
        <h3>
          <% if (hasReviews) { %>
            ★ <%= avgRating %> · <%= reviewsArr.length %> reviews
          <% } else { %>
            No reviews yet
          <% } %>
        </h3>

        <!-- Add Review (old logic, new look) -->
        <% if (user) { %>
          <div class="add-review">
            <h4>Add Review</h4>
            <form action="/listings/<%= listing._id %>/reviews" method="POST">
              <div class="range-wrap">
                <label style="font-weight:700;">Rating</label>
                <input
                  id="ratingRange"
                  type="range"
                  min="1"
                  max="5"
                  value="3"
                  name="review[rating]"
                  class="form-range"
                  required
                >
                <span class="value"><span id="ratingValue">3</span>/5</span>
              </div>

              <label style="font-weight:700; margin-bottom:8px;">Comment</label>
              <textarea
                name="review[comment]"
                rows="4"
                placeholder="Share your experience with other travelers..."
                required
              ></textarea>

              <button class="reserve-btn" type="submit">Submit</button>
            </form>
          </div>
        <% } else { %>
          <p><a href="/login">Login</a> to add a review</p>
        <% } %>

        <!-- All Reviews -->
        <% if (!hasReviews) { %>
          <p>No reviews yet.</p>
        <% } else { %>
          <div class="reviews-grid">
            <% for (let review of reviewsArr) { %>
              <%
                const a = review?.author || null;
                const canDelete = !!(user && a && a._id && user._id && a._id.equals(user._id));
              %>

              <div class="review">
                <div class="review-header">
                  <div class="review-avatar">
                    <%= a?.username ? a.username.charAt(0).toUpperCase() : "?" %>
                  </div>
                  <div class="review-author">
                    <h4><%= a?.username || "Unknown" %></h4>
                    <p><%= review?.createdAt ? new Date(review.createdAt).toLocaleDateString('en-IN', { month: 'long', year: 'numeric' }) : "" %></p>
                  </div>
                </div>

                <div class="review-rating">
                  <%= '★'.repeat(review.rating || 0) + '☆'.repeat(5 - (review.rating || 0)) %>
                </div>

                <p class="review-text"><%= review.comment %></p>

                <% if (canDelete) { %>
                  <form method="POST" action="/listings/<%= listing._id %>/reviews/<%= review._id %>?_method=DELETE">
                    <button class="delete-review" type="submit">Delete</button>
                  </form>
                <% } %>
              </div>
            <% } %>
          </div>
        <% } %>
      </div>
    </div>

    <!-- RIGHT -->
    <div class="sidebar">
      <div class="booking-card">
        <div class="price">₹ <%= (listing.price || 0).toLocaleString("en-IN") %> <span>night</span></div>

        <a href="#" class="reserve-btn">Reserve</a>

        <% if (isOwner) { %>
          <div class="edit-delete-btns">
            <a href="/listings/<%= listing._id %>/edit" class="btn-edit">Edit</a>
            <form method="POST" action="/listings/<%= listing._id %>?_method=DELETE" style="flex:1; margin:0;">
              <button type="submit" class="btn-delete" style="width:100%;">Delete</button>
            </form>
          </div>
        <% } %>
      </div>
    </div>
  </div>
</div>

<script>
  // ✅ Update range value text
  const range = document.getElementById('ratingRange');
  const out = document.getElementById('ratingValue');
  if (range && out) {
    out.textContent = range.value;
    range.addEventListener('input', () => out.textContent = range.value);
  }
</script>
